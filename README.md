# Nagios NRPE plugin - monitor SeisComP3 modules

## Presentation

This Nagios plugin monitors the response time of various
[SeisComP3](https://www.seiscomp3.org/) modules.

It is based on the status files generated by the SeisComP3 `scm` module.
Hence only the modules monitored by `scm` can be monitored with this plugin.
SeedLink, Arclink are not monitored by `scm`.

The `scm` module updates its status files every less-than-10 seconds.
In order to avoid writing those ephemeral status files on physical storage,
we will configure `scm` to write it in memory, inside `/dev/shm/scm` directory
instead of the default `.seiscomp3/log/scm` directory.

SeisComP3 won't create the `/dev/shm/scm` directory. Hence we set up a script
`create_scm_working_dir.sh` which will create the directory when it is missing.
We will use `cron` daemon to periodically run this script.
If you choose to go with the default `.seiscomp3/log/scm` location,
you don't need this script. SeisComP3 will take care of creating the
directory `.seiscomp3/log/scm`.

Your Nagios monitoring server will call this plugin through NRPE (Nagios Remote
Plugin Executor). All the configuration steps and files provided here
need to be performed/installed on the server running SeisComP3, not on the
Nagios monitoring server.

Below, monitoring server refers to the Nagios monitoring server, whereas
NRPE server refers to the server running SeisComP3. Installation and 
configuration of the Nagios monitoring server won't be dealt here. Only
installation and configuration of the NRPE server will.

## Installation

### NRPE server software

On debian and ubuntu, this is provided by the package **nagios-nrpe-server**

### Plugin file and script creating the scm working directory

* install the Nagios plugin script under:

    `/usr/local/lib/nagios/plugins/check_sc3_module`

* install the script for creating the scm working directory under, eg:

    `$HOME/bin/create_scm_working_dir.sh`

    with `$HOME` the home directory of the user running SeisComP3

## Configuration

### SeisComP3 scm module

The configuration of scm module is expected under
`<sc3_install_dir>/etc/scm.cfg` or `$HOME/.seiscomp3/scm.cfg`
and need to at least enable `mtextplugin` and specify the
`mtextplugin.outputDir`, like this:

```
plugins = mtextplugin

# Output directory where [client].txt is written to. Additionally an file
# description.txt will be created to show the order of tags used in the
# client status file. Default is @LOGDIR@/scm/.
mtextplugin.outputDir = /dev/shm/scm
```

### Creation of scm working directory

* The `create_scm_working_dir.sh` script takes the path of `scm` working
directory directly from the file `scm.cfg`, whatever its location.

* The script can restart `scm` module upon creation of the directory. This
may be necessary when `scm` starts before the working directory has been
created. We have encountered that, when the working directory is created
afterwards, `scm` does not write all the files required by the Nagios plugin.
Restarting `scm` solves the issue. To instruct the restart of `scm`, set:

    `f_restart_scm=true`

    `seiscomp_cmd="$HOME/seiscomp3/bin/seiscomp"`

* Make the script executable:

    `chmod +x $HOME/bin/create_scm_working_dir.sh`

* The crontab of the user running SeisComP3 needs a line like this:

    `*/5 * * * * bin/create_scm_working_dir.sh >/dev/null 2>&1`

### NRPE

* The NRPE server main configufation file, `/etc/nagios/nrpe.cfg` on debian, needs to:

    * allow connection from the IP of your Nagios monitoring server:

    `allowed_hosts=127.0.0.1, <ip_of_your_monitoring_server>`

    * allow the monitoring server to pass arguments:

    `dont_blame_nrpe=1`

    * define the command the client needs to execute:

    `command[check_sc3_module]=/usr/local/lib/nagios/plugins/check_sc3_module $ARG1$`

* Finally restart the NRPE server

### sc3_check_module plugin

* The plugin needs to be configured. Edit the file `/usr/local/lib/nagios/plugins/check_sc3_module` and set:
    * `SCM_WORK_DIR`: the path of `scm` module working directory
    * `DSC_FILE`: the path to the file describing the columns inside the status files generated by `scm`.
    * `WARNING_THRESHOLD`: response time threshold, in seconds, above which a WARNING state is reported
    * `CRITICAL_THRESHOLD`: response time threshold, in seconds, above which a CRITICAL state is reported

## Testing

On debian and ubuntu, the package **nagios-nrpe-plugin** provides the 
command `/usr/lib/nagios/plugins/check_nrpe`.

You can use the command this way:

`/usr/lib/nagios/plugins/check_nrpe -H my_seiscomp_server_IP -c check_sc3_module -a my_module_name`

with:
* `my_seiscomp_server_IP`: the IP of your NRPE server (i.e. your SeisComP3 server)
* `my_module_name`: the name of whatever running module (e.g. scmag, scautopick, ...)

If you encounter a *Socket timeout* error when running `check_nrpe` command,
you can try adding the option `-n`.

### Example of output

```
$ /usr/lib/nagios/plugins/check_nrpe -nH my_sc3_server_ip -c check_sc3_module -a scmag
OK: 6 seconds since last response

$ /usr/lib/nagios/plugins/check_nrpe -nH my_sc3_server_ip -c check_sc3_module -a scvoice
WARNING: 68 seconds since last response

$ /usr/lib/nagios/plugins/check_nrpe -nH my_sc3_server_ip -c check_sc3_module -a scautoloc
CRITICAL: 607 seconds since last response
```
